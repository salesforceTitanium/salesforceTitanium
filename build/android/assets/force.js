function info(e){Ti.API.info("[Force.com] "+e)}function error(e){Ti.API.error("[Force.com] "+e)}var API_VERSION="v25.0",CONSUMER_KEY=Ti.App.Properties.getString("force.consumer.key"),CONSUMER_SECRET=Ti.App.Properties.getString("force.consumer.secret"),REDIRECT_URI="https://login.salesforce.com/services/oauth2/success",LOGIN_URL="https://login.salesforce.com/services/oauth2/authorize?display=touch&response_type=token&client_id="+Ti.Network.encodeURIComponent(CONSUMER_KEY)+"&redirect_uri="+REDIRECT_URI,INSTANCE_URL=Ti.App.Properties.getString("force.instanceURL"),ACCESS_TOKEN=Ti.App.Properties.getString("force.accessToken"),REFRESH_TOKEN=Ti.App.Properties.getString("force.refreshToken");exports.authorize=function(e){function r(){function r(){t.close(),e.cancel&&e.cancel()}var t=Ti.UI.createWindow({modal:!0,title:"Force.com Login1"}),o=Ti.UI.createWebView({height:Ti.UI.FILL,widht:Ti.UI.FILL,url:LOGIN_URL});t.add(o);var i;if("android"!==Ti.Platform.osname){var n=Ti.UI.createButton({title:"Cancel",style:Ti.UI.iPhone.SystemButtonStyle.PLAIN});t.setRightNavButton(n),n.addEventListener("click",r)}else t.addEventListener("android:back",r),t.addEventListener("open",function(){i=Ti.UI.createActivityIndicator({location:Ti.UI.ActivityIndicator.STATUS_BAR,type:Ti.UI.ActivityIndicator.DETERMINANT,message:"Loading..."}),i.show()});return o.addEventListener("load",function(e){i&&i.hide(),t.fireEvent("urlChanged",e)}),t}if(ACCESS_TOKEN)e.success();else{var t=new r;t.addEventListener("urlChanged",function(r){if(-1!==r.url.indexOf("/oauth2/success")){for(var o=r.url.split("#")[1],i=o.split("&"),n=0,s=i.length;s>n;n++){var c=i[n].split("=");switch(c[0]){case"access_token":ACCESS_TOKEN=Ti.Network.decodeURIComponent(c[1]),Ti.App.Properties.setString("force.accessToken",ACCESS_TOKEN);break;case"refresh_token":REFRESH_TOKEN=Ti.Network.decodeURIComponent(c[1]),Ti.App.Properties.setString("force.refreshToken",REFRESH_TOKEN);break;case"instance_url":INSTANCE_URL=Ti.Network.decodeURIComponent(c[1]),Ti.App.Properties.setString("force.instanceURL",INSTANCE_URL)}}e.success(),t.close()}}),t.open()}},exports.logout=function(){ACCESS_TOKEN=null,Ti.App.Properties.setString("force.accessToken",ACCESS_TOKEN),REFRESH_TOKEN=null,Ti.App.Properties.setString("force.refreshToken",REFRESH_TOKEN),INSTANCE_URL=null,Ti.App.Properties.setString("force.instanceURL",INSTANCE_URL)},exports.request=function(e){var r=Ti.Network.createHTTPClient();r.timeout=e.timeout?e.timeout:25e3,r.onload=function(){try{info(JSON.stringify(r)),Number(r.status)>=200&&Number(r.status)<300?e.callback&&e.callback(JSON.parse(this.responseText)):e.onerror?e.onerror():error("Error during Force.com request")}catch(t){r.onerror(t)}},e.ondatastream&&(r.ondatastream=function(){e.ondatastream&&e.ondatastream()}),r.onerror=function(){401===r.status?(alert("Session expired - please log in."),exports.logout(),exports.authorize()):(e.onerror&&e.onerror(),Ti.API.info(r.responseText))};var t=INSTANCE_URL+"/services/data/"+API_VERSION+e.url;if(info(t),e.type?r.open(e.type,t):r.open("GET",t),r.validatesSecureCertificate=!0,r.setRequestHeader("Content-Type","application/json"),r.setRequestHeader("Authorization","OAuth "+ACCESS_TOKEN),r.setRequestHeader("X-User-Agent","salesforce-toolkit-rest-javascript/"+API_VERSION),e.headers)for(var o=0,i=e.headers.length;i>o;o++)r.setRequestHeader(e.headers[o].name,e.headers[o].value);r.send(e.data?JSON.stringify(e.data):null)};